#!/bin/sh

set -eu

STATE_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/emacsd"
CURRENT_LOGFILE="$STATE_DIR/.emacsd-current.log"
[ -d "$STATE_DIR" ] || mkdir -p "$STATE_DIR"

usage() {
  cat << EOF
usage: emacsd {start/up|stop/down|restart|status|logs|version|help}

commands:
  start|up    start emacs daemon
  stop|down   stop the running emacs daemon
  restart     restart the running emacs daemon, if not running will start it
  status      show daemon status, pid, version and log path
  logs        manage daemon logs
    show      show daemon logs
      -f      follow logs
    clean     delete all logfiles (except the current, if daemon is running)
  version     print emacsd version
  help        show this help
EOF
}

version() {
  echo "emacsd - v0.1.0"
}

is_running() {
  emacsclient -e 't' >/dev/null 2>&1
}

pid() {
  emacsclient -e '(emacs-pid)'
}

exit_emacs() {
  has_unsaved=$(emacsclient -e \
    '(if (seq-some (lambda (b)
                     (and (buffer-file-name b) (buffer-modified-p b)))
                   (buffer-list)) 1 0)' 2> /dev/null)

  if [ "$has_unsaved" -eq 1 ]; then
    echo "you have unsaved work, resolve this first"
    exited=$(emacsclient -n -r -e \
      '(progn
         (select-frame-set-input-focus (selected-frame))
         (save-buffers-kill-emacs))' 2> /dev/null)

    if [ -z "$exited" ]; then
      return 0
    else
      echo "user aborted the shutdown"
      return 1
    fi
  fi

  emacsclient -e '(kill-emacs)' > /dev/null 2>&1
}

log() {
  echo "$1"
  echo "$(date '+%F %T') emacsd: $1" >> "$CURRENT_LOGFILE"
}

prune_logs() {
  set -- "$STATE_DIR"/emacsd*.log

  if [ "$#" -ge 10 ]; then
    to_remove=$(ls -1 "$STATE_DIR"/emacsd*.log | head -n -9)
    echo "more than 10 logfiles, going to remove $(basename $to_remove)"
    rm -f "$to_remove"
    echo "removed $(basename $to_remove) successfully"
  fi
}

clean_logs() {
  if ! is_running; then
    rm -f "$STATE_DIR"/*.log "$CURRENT_LOGFILE"
    return 0
  fi

  fd -d1 -tf -E "emacsd*-$(pid).log" . "$STATE_DIR" -X rm -f
}

show_logs() {
  if [ ! -f "$CURRENT_LOGFILE" ]; then
    echo "no logs to show"
    return 1
  fi

  bat --language=log --style=numbers "$CURRENT_LOGFILE"
}

follow_logs() {
  if [ ! -f "$CURRENT_LOGFILE" ]; then
    echo "no logs to follow"
    return 1
  fi

  tail -F -n +1 "$CURRENT_LOGFILE" 2> /dev/null \
    | bat --paging=never --language=log --style=numbers
}

start() {
  if is_running; then
    echo "emacsd already running"
    return 1
  fi

  ts="$(date +%Y%m%d%H%M%S)"
  logfile="$STATE_DIR/emacsd-$ts.log"
  prune_logs
  ln -sf "$logfile" "$CURRENT_LOGFILE"

  log "starting emacsd"
  setsid -f sh -c '/usr/bin/emacs --fg-daemon --chdir="'"$HOME"'" < /dev/null 2>&1 \
    | while IFS= read -r l; do echo "$(date "+%F %T") emacs: $l"; done >> "'"$CURRENT_LOGFILE"'"' \
    > /dev/null 2>&1 < /dev/null &

  n=50
  while [ "$n" -gt 0 ]; do
    if is_running; then
      new_logfile="$STATE_DIR/emacsd-$ts-$(pid).log"
      mv -f "$logfile" "$new_logfile"
      ln -sf "$new_logfile" "$CURRENT_LOGFILE"

      log "started emacsd"
      return 0
    fi

    n=$((n - 1))
    sleep 0.1
  done

  log "failed to start emacsd"
  echo "see logs at $(readlink -f "$CURRENT_LOGFILE")"
  return 1
}

stop() {
  if ! is_running; then
    echo "emacsd not running"
    return 1
  fi

  log "stopping emacsd"

  if ! exit_emacs; then
    log "failed to request emacs shutdown"
    return 1
  fi

  n=50
  while [ "$n" -gt 0 ]; do
    if ! is_running; then
      log "stopped emacsd"
      return 0
    fi

    n=$((n - 1))
    sleep 0.1
  done

  log "failed to stop emacsd"
  echo "see logs at $(readlink -f "$CURRENT_LOGFILE")"
  return 1
}

restart() {
  if ! is_running; then echo "emacsd not running"; return 1; fi
  stop
  start
}

status() {
  if is_running; then
    echo "emacsd: up"
    echo "pid: $(pid)"
    emacsclient -e '(format "version: %s" emacs-version)' | tr -d '"'
    echo "log: $(readlink -f "$CURRENT_LOGFILE")"
  else
    echo "emacsd: down"
  fi
}

cmd="${1-}"
case "$cmd" in
  start|up) start;;
  stop|down) stop;;
  restart) restart;;
  status) status;;
  logs)
    shift
    cmd="${1-}"
    case "$cmd" in
      show)
        shift
        flag="${1-}"
        case "$flag" in
          -f) follow_logs;;
          "") show_logs;;
          *) echo "unknown flag: $flag"; usage; exit 1;;
        esac;;
      "") show_logs;;
      -f) follow_logs;;
      clean) clean_logs;;
      *) echo "unknown argument: $cmd"; usage; exit 1;;
    esac;;
  version) version;;
  help) usage;;
  "") usage; exit 1;;
  *) echo "unknown argument: $cmd"; usage; exit 1;;
esac
