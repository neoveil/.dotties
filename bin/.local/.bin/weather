#!/bin/bash
set -euo pipefail

err() {
  printf 'error: %s\n' "$*" >&2
}

usage() {
  cat >&2 << EOF
Usage: ${0##*/} [-c CITY] [-f FORMAT]

Query wttr.in for weather information.

Options:
  -c  set the city name (spaces will be replaced with underscores)
  -f  set the wttr.in format string (spaces will be replaced with '+')
  -h  show this help message and exit
EOF
  exit 1
}

sanitize_input() {
  printf "%s" "$1" | sed -e "s/[[:space:]]/$2/g"
}

city=""
format=""

while getopts ":c:f:h" opt; do
  case "$opt" in
    c) city="/$(sanitize_input "$OPTARG" "_")";;
    f) format="?format=$(sanitize_input "$OPTARG" "+")";;
    h) usage;;
    :) err "option -$OPTARG requires an argument"; usage;;
    ?) err "unknown option: -$OPTARG"; usage;;
  esac
done
shift $((OPTIND - 1))

if (( $# > 0 )); then
  err "unexpected extra argument: $1"
  usage
fi

curl -s "wttr.in$city$format"
