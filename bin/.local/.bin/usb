#!/bin/sh

set -eu

BASE_PATH="/run/media/$USER"

usage() {
  program=$(basename "$0")

  cat << EOF
Usage: $program <operation> <device>

Manage USB storage devices: mount, unmount, or safely eject.

Operations:
  -m, --mount    mount all partitions from a USB storage device
  -u, --umount   unmount all partitions from a USB storage device and clean mount dirs
  -e, --eject    safely unmount and power off a USB storage device
EOF
  exit 1
}

check_usb_device() {
  dev="$1"
  [ -z "$dev" ] && { echo "error: device not specified"; usage; }
  [ ! -b "/dev/$dev" ] && { echo "error: /dev/$dev is not a block device"; exit 1; }

  tran=$(lsblk -no TRAN "/dev/$dev" 2>/dev/null | head -n1 || echo "")
  [ "$tran" != "usb" ] && {
    echo "error: /dev/$dev is not a USB device (TRAN='$tran')"
    echo "aborting to avoid touching an internal disk"
    exit 1
  }

  return 0
}

mount_usb() {
  dev="$1"
  check_usb_device "$dev"

  path="$BASE_PATH/$dev"
  echo "mounting partitions from /dev/$dev under $path..."
  sudo mkdir -p "$path"

  for part in /dev/"$dev"?*; do
    [ -b "$part" ] || continue

    mp=$(lsblk -no MOUNTPOINT "$part")
    [ -n "$mp" ] && { echo "  $part already mounted at $mp, skipping"; continue; }

    fstype=$(lsblk -no FSTYPE "$part")
    [ -z "$fstype" ] && { echo "  could not detect filesystem for $part, skipping"; continue; }

    pname=$(basename "$part")
    mp="$path/$pname"

    echo "  mounting $part at $mp..."
    sudo mkdir -p "$mp"
    sudo mount -t "$fstype" "$part" "$mp"

    label=$(lsblk -no LABEL "$part")
    [ -n "$label" ] && {
      safe_label=$(printf "%s" "$label" | tr ' ' '_')
      echo "    linking label name: $safe_label -> $pname"
      sudo ln -sfn "$pname" "$path/$safe_label"
    }
  done

  echo "linking /mnt/$dev -> $path"
  sudo mkdir -p /mnt
  sudo ln -sfn "$path" "/mnt/$dev"

  echo "done"
}

umount_usb() {
  dev="$1"
  check_usb_device "$dev"

  path="$BASE_PATH/$dev"
  echo "unmounting partitions of /dev/$dev..."

  for part in /dev/"$dev"?*; do
    [ -b "$part" ] || continue

    mp=$(lsblk -no MOUNTPOINT "$part")
    if [ -n "$mp" ]; then
      echo "  unmounting $part from $mp"
      sudo umount "$mp"
    else
      echo "  $part was not mounted"
    fi
  done

  echo "cleaning up symlinks and directories..."

  [ -L "/mnt/$dev" ] && { echo "  removing /mnt/$dev"; sudo rm -f "/mnt/$dev"; }
  [ -d "$path" ] && {
    sudo find "$path" -maxdepth 1 -mindepth 1 -exec rm -rf {} +
    echo "  removing $path"
    sudo rmdir "$path" 2>/dev/null || true
  }

  echo "done"
}

eject_usb() {
  dev="$1"
  check_usb_device "$dev"
  umount_usb "$dev"

  echo "ejecting /dev/$dev..."
  udisksctl power-off -b "/dev/$dev"
  echo "done"
}

op=""
dev=""

[ $# -eq 0 ] && usage

while [ $# -gt 0 ]; do
  case "$1" in
    -m|--mount)
      [ -n "$op" ] && { echo "error: multiple operations specified"; usage; }
      op="mount";;
    -u|--umount)
      [ -n "$op" ] && { echo "error: multiple operations specified"; usage; }
      op="umount";;
    -e|--eject)
      [ -n "$op" ] && { echo "error: multiple operations specified"; usage; }
      op="eject";;
    -h|--help) usage;;
    -*) echo "error: unknown option: $1"; usage;;
    *)
      [ -n "$dev" ] && { echo "error: unexpected extra argument: $1"; usage; }
      dev="$1";;
  esac
  shift
done

[ -z "$op" ] && { echo "error: no operation specified"; usage; }
[ -z "$dev" ] && { echo "error: no device specified"; usage; }

case "$op" in
  mount) mount_usb "$dev";;
  umount) umount_usb "$dev";;
  eject) eject_usb "$dev";;
esac
