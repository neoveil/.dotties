#!/bin/sh

BACKGROUND_DIR="$HOME/Pictures/.backgrounds/"
METAFILE="$BACKGROUND_DIR/.metafile"
CURRENT_LN="$BACKGROUND_DIR/.current"

usage() {
  echo "usage: background {next|refresh|shuffle}" >&2
  exit 1
}

rename() {
  fd -tf -e jpg -e png -e jpeg . "$BACKGROUND_DIR" \
    | nl -w1 -s ' ' \
    | while read n f; do
        mv -- "$f" "$BACKGROUND_DIR/$n.${f##*.}.tmp"
      done

  fd -tf -E tmp . "$BACKGROUND_DIR" -x mv -- {} {.}
}

refresh() {
  rename
  fd -tf -e jpg -e png -e jpeg . "$BACKGROUND_DIR" | shuf > "$METAFILE"
  rm -f "$CURRENT_LN"
  hyprctl hyprpaper unload all > /dev/null 2>&1
  set_next_background
}

shuffle() {
  shuf "$METAFILE" | sponge "$METAFILE"
}

set_next_background() {
  current_index=$(grep -n "$(hyprctl hyprpaper listloaded)" "$METAFILE" | cut -d: -f1)

  if [ -z "$current_index" ]; then
    next=$(head -n1 "$METAFILE")
  else
    next_index=$((current_index + 1))

    if [ "$next_index" -gt "$(wc -l < "$METAFILE")" ]; then
      next=$(head -n1 "$METAFILE")
    else
      next=$(sed -n "${next_index}p" "$METAFILE")
    fi
  fi

  ln -sf "$next" "$CURRENT_LN"
  pidof hyprlock > /dev/null && kill -USR2 $(pidof hyprlock)
  hyprctl hyprpaper reload ",$next" > /dev/null 2>&1
}

if [ ! -f "$METAFILE" ]; then refresh; fi

case "$1" in
  refresh) refresh;;
  shuffle) shuffle;;
  next) set_next_background;;
  *) usage;;
esac
