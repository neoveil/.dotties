#!/bin/bash
set -euo pipefail

THEME="${XDG_CONFIG_HOME:-$HOME/.config}/rofi/powermenu.rasi"
ROFI_CMD=(rofi -theme "$THEME")

UPTIME=$(uptime -p | sed 's/^up //g')
TERMINAL="  terminal"
SHUTDOWN="  shutdown"
REBOOT="󰜉  restart"
SUSPEND="󰒲  sleep"
LOCK="  lock"
LOGOUT="  logout"
OPTS="$SHUTDOWN\n$REBOOT\n$LOCK\n$LOGOUT\n$SUSPEND\n$TERMINAL"

confirm() {
  local answer
  answer="$("${ROFI_CMD[@]}" -dmenu -i -no-fixed-num-lines -p "are you sure? (y/N) > " || true)"
  [[ "$answer" == "y" || "$answer" == "Y" ]]
}

case "$(echo -e "$OPTS" | "${ROFI_CMD[@]}" -dmenu -selected-row 0 -p "uptime: $UPTIME")" in
  "$SHUTDOWN") confirm && systemctl poweroff;;
  "$REBOOT") confirm && systemctl reboot;;
  "$LOCK") loginctl lock-session;;
  "$SUSPEND") confirm && { playerctl -a pause 2> /dev/null || true; systemctl suspend; };;
  "$LOGOUT") confirm && loginctl terminate-user "";;
  "$TERMINAL") kitty ~/;;
  "") exit 0;;
  *) exit 1;;
esac
