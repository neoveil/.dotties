#!/bin/bash
set -euo pipefail
shopt -s nullglob

UNINSTALL=false
PKGS=()
EXCLUDED_PKGS=()

for dir in */; do
  name=${dir%/}
  [[ $name == ".git" ]] && continue
  PKGS+=("$name")
done

usage() {
  cat >&2 << EOF
Usage: ${0##*/} [-u] [-p <packages...>] [-e <packages...>]

Manage stow-based dotfiles installation.

Options:
  -u  uninstall instead of install
  -p  operate only on the given packages
  -e  exclude given packages
  -h  show this help and exit
EOF
  exit 1
}

has_package() {
  local pkg="$1"

  for element in "${PKGS[@]}"; do
    [[ "$element" == "$pkg" ]] && return 0
  done

  return 1
}

link() {
  local pkg=$1 from=$2 to=$3

  has_package "$pkg" || { echo "$pkg package not found. skipping linking phase"; return; }
  mkdir -pv "$to"

  for file in "$from/"*; do
    [[ -e "$file" ]] || continue

    if [[ -L "$to/$(basename "$file")" ]]; then
      echo "skipping $file: already linked"
    else
      ln -sv "$file" "$to"
    fi
  done
}

unlink() {
  local pkg=$1 from=$2 matching_with=$3 target

  has_package "$pkg" || { echo "$pkg package not found. skipping unlinking phase"; return; }
  [[ -d "$from" ]] || return

  for file in "$matching_with/"*; do
    target="$from/$(basename "$file")"
    [[ -L "$target" ]] && rm -v "$target"
  done
}

command -v stow > /dev/null 2>&1 || { echo "stow could not be found. is it installed?" >&2; exit 1; }

while (( $# > 0 )); do
  case "$1" in
    -h) usage;;
    -u) UNINSTALL=true
        shift;;
    -p) shift
        PKGS=()
        while (( $# > 0 )) && [[ ${1:0:1} != "-" ]]; do
          PKGS+=("$1")
          shift
        done;;
    -e) shift
        while (( $# > 0 )) && [[ ${1:0:1} != "-" ]]; do
          EXCLUDED_PKGS+=("$1")
          shift
        done;;
    -*) echo "unknown option: $1" >&2; usage;;
    *) echo "unexpected argument: $1" >&2; usage;;
  esac
done

(( ${#EXCLUDED_PKGS[@]} > 0 )) && {
  filtered=()

  for pkg in "${PKGS[@]}"; do
    skip=false

    for ex in "${EXCLUDED_PKGS[@]}"; do
      [[ "$pkg" == "$ex" ]] && { skip=true; break; }
    done

    [[ "$skip" == true ]] || filtered+=("$pkg")
  done

  PKGS=("${filtered[@]}")
}

if [[ "$UNINSTALL" == true ]]; then
  unlink systemd "$HOME/.config/systemd/user" "$HOME/.config/systemd/units"
  unlink systemd "$HOME/.config/systemd/user" "$HOME/.config/systemd/timers"
  unlink bin "$HOME/.local/bin" "$HOME/.local/.bin"
  stow -D -vv "${PKGS[@]}"
else
  stow -vv "${PKGS[@]}"
  link systemd "$HOME/.config/systemd/units" "$HOME/.config/systemd/user"
  link systemd "$HOME/.config/systemd/timers" "$HOME/.config/systemd/user"
  link bin "$HOME/.local/.bin" "$HOME/.local/bin"
fi
