#!/bin/sh
set -eu

WINDOW=$(hyprctl activewindow -j) || exit 0
WINDOW_ADDRESS=$(printf '%s\n' "$WINDOW" | jq -r '.address')
WORKSPACE_ID=$(printf '%s\n' "$WINDOW" | jq '.workspace.id')

in_group() {
  hyprctl activewindow -j | jq -e '(.grouped // [] | length) > 0' > /dev/null 2>&1
}

workspace_windows() {
  hyprctl clients -j | jq -r ".[] | select(.workspace.id == $WORKSPACE_ID) | .address"
}

HAD_GROUP="$(in_group && echo true || echo false)"
hyprctl -q dispatch togglegroup

if [ "$HAD_GROUP" = false ]; then
  for window in $(workspace_windows); do
    [ "$window" = "$WINDOW_ADDRESS" ] && continue

    hyprctl -q dispatch focuswindow "address:$window"

    for direction in l r u d; do
      if in_group; then break; fi
      hyprctl -q dispatch moveintogroup "$direction"
    done
  done
fi

hyprctl -q dispatch focuswindow "address:$WINDOW_ADDRESS"
