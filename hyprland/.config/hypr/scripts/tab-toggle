#!/bin/bash
set -euo pipefail

WINDOW=$(hyprctl activewindow -j) || exit 0
WINDOW_ADDRESS=$(printf '%s\n' "$WINDOW" | jq -r '.address')
WORKSPACE_ID=$(printf '%s\n' "$WINDOW" | jq '.workspace.id')

in_group() {
  hyprctl activewindow -j | jq -e '(.grouped // [] | length) > 0' > /dev/null 2>&1
}

workspace_windows() {
  hyprctl clients -j | jq -r ".[] | select(.workspace.id == $WORKSPACE_ID) | .address"
}

HAD_GROUP=false
in_group && HAD_GROUP=true

hyprctl -q dispatch togglegroup

[[ "$HAD_GROUP" == false ]] && {
  while IFS= read -r window; do
    [[ "$window" == "$WINDOW_ADDRESS" ]] && continue

    hyprctl -q dispatch focuswindow "address:$window"

    for direction in l r u d; do
      in_group && break
      hyprctl -q dispatch moveintogroup "$direction"
    done
  done < <(workspace_windows)
}

hyprctl -q dispatch focuswindow "address:$WINDOW_ADDRESS"
