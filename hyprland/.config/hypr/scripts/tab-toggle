#!/bin/sh
set -eu

INITIAL_FOCUSED=$(hyprctl activewindow -j) || exit 0
INITIAL_FOCUSED_ADDRESS=$(printf '%s\n' "$INITIAL_FOCUSED" | jq -r '.address')
WORKSPACE_ID=$(printf '%s\n' "$INITIAL_FOCUSED" | jq '.workspace.id')

in_group() {
  hyprctl activewindow -j |\
    jq '((.grouped // []) | length) > 0' |\
    rg -q true
}

grouped_windows() {
  hyprctl activewindow -j | jq -r '.grouped[]?'
}

workspace_windows() {
  hyprctl clients -j |\
    jq -r ".[] | select(.workspace.id == $WORKSPACE_ID) | .address"
}

if in_group; then
  for window in $(grouped_windows); do
    hyprctl -q dispatch moveoutofgroup "address:$window"
  done

  hyprctl -q dispatch focuswindow "address:$INITIAL_FOCUSED_ADDRESS"
  exit 0
fi

hyprctl -q dispatch togglegroup

for window in $(workspace_windows); do
  [ "$window" != "$INITIAL_FOCUSED_ADDRESS" ] || continue

  hyprctl -q dispatch focuswindow "address:$window"

  for direction in l r u d; do
    if in_group; then break; fi
    hyprctl -q dispatch moveintogroup "$direction"
  done
done

hyprctl -q dispatch focuswindow "address:$INITIAL_FOCUSED_ADDRESS"
